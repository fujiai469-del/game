<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ ªå¼ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ </title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
:root {
  --color-up: #6ec77a;
  --color-up-rgb: 110,199,122;
  --color-down: #e07272;
  --color-down-rgb: 224,114,114;
}
:root.color-reverse {
  --color-up: #e07272;
  --color-up-rgb: 224,114,114;
  --color-down: #6ec77a;
  --color-down-rgb: 110,199,122;
}
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
  background: #1a1d2e;
  color: #e0e0e0;
  height: 100vh;
  height: 100dvh;
  overflow: hidden;
}

/* ========== ãƒ˜ãƒƒãƒ€ãƒ¼ ========== */
.header {
  background: rgba(255,255,255,0.04);
  border-bottom: 1px solid rgba(255,255,255,0.08);
  padding: 8px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  height: 48px;
}
.header-left { display: flex; align-items: center; gap: 8px; }
.header-left .logo { font-size: 18px; }
.header-left h1 { font-size: 15px; font-weight: 700; color: #c8cad0; }
.header-right { display: flex; gap: 8px; align-items: center; }
.stat-box {
  text-align: center;
  padding: 4px 10px;
  border-radius: 8px;
  background: rgba(255,255,255,0.06);
}
.stat-box .label { font-size: 10px; color: rgba(255,255,255,0.45); }
.stat-box .value { font-size: 14px; font-weight: 700; color: #c8cad0; }
.stat-box .value.positive { color: var(--color-up); }
.stat-box .value.negative { color: var(--color-down); }
.timer-box .value { color: #e8c56a; }

/* ========== ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ========== */
.main {
  display: grid;
  grid-template-columns: 220px 1fr 280px;
  gap: 10px;
  padding: 10px;
  height: calc(100vh - 48px);
  height: calc(100dvh - 48px);
  overflow: hidden;
}

/* ========== éŠ˜æŸ„ãƒªã‚¹ãƒˆ ========== */
.stock-list {
  background: rgba(255,255,255,0.04);
  border-radius: 12px;
  padding: 10px;
  overflow-y: auto;
  border: 1px solid rgba(255,255,255,0.06);
}
.stock-list h2 { font-size: 12px; margin-bottom: 8px; color: rgba(255,255,255,0.5); }
.stock-item {
  padding: 8px 10px;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.15s;
  margin-bottom: 4px;
  border: 2px solid transparent;
  background: rgba(255,255,255,0.02);
}
.stock-item:hover { background: rgba(255,255,255,0.06); }
.stock-item.selected { border-color: #7b8abd; background: rgba(123,138,189,0.12); }
.stock-item .stock-name { font-weight: 700; font-size: 13px; color: #d0d2d8; }
.stock-item .stock-ticker { font-size: 11px; color: rgba(255,255,255,0.4); }
.stock-item .stock-price { font-size: 14px; font-weight: 700; color: #c8cad0; }
.stock-item .stock-change { font-size: 11px; margin-top: 1px; }
.stock-item .stock-change.up { color: var(--color-up); }
.stock-item .stock-change.down { color: var(--color-down); }
.si-row { display: flex; justify-content: space-between; align-items: center; }

/* ========== ãƒãƒ£ãƒ¼ãƒˆã‚¨ãƒªã‚¢ ========== */
.chart-area {
  background: rgba(255,255,255,0.04);
  border-radius: 12px;
  padding: 12px;
  display: flex;
  flex-direction: column;
  border: 1px solid rgba(255,255,255,0.06);
  overflow: hidden;
  min-height: 0;
}
.chart-header { margin-bottom: 8px; }
.chart-header .stock-info h2 { font-size: 15px; font-weight: 700; color: #c8cad0; }
.chart-header .stock-info .current-price { font-size: 22px; font-weight: 800; color: #e0e0e0; }
.chart-header .stock-info .price-change { font-size: 13px; margin-top: 1px; }
.chart-header .stock-info .price-change.up { color: var(--color-up); }
.chart-header .stock-info .price-change.down { color: var(--color-down); }
.chart-canvas-container { flex: 1; position: relative; min-height: 0; }
.chart-canvas-container canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

/* ========== å–å¼•ãƒ‘ãƒãƒ« ========== */
.trade-panel { display: flex; flex-direction: column; gap: 8px; overflow-y: auto; }
.panel-card {
  background: rgba(255,255,255,0.04);
  border-radius: 12px;
  padding: 12px;
  border: 1px solid rgba(255,255,255,0.06);
}
.panel-card h3 { font-size: 12px; color: rgba(255,255,255,0.5); margin-bottom: 8px; }

.trade-buttons { display: flex; gap: 6px; margin-bottom: 8px; }
.btn-trade {
  flex: 1;
  padding: 12px 8px;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.15s;
}
.btn-trade:hover { transform: translateY(-1px); opacity: 0.9; }
.btn-trade:active { transform: translateY(0); }
.btn-trade.buy-btn { background: linear-gradient(135deg, rgba(var(--color-up-rgb),0.85), rgba(var(--color-up-rgb),0.7)); color: #fff; }
.btn-trade.sell-btn { background: linear-gradient(135deg, rgba(var(--color-down-rgb),0.85), rgba(var(--color-down-rgb),0.7)); color: #fff; }

.trade-settings { display: flex; gap: 8px; margin-bottom: 8px; }
.setting-group { flex: 1; }
.setting-group label { display: block; font-size: 11px; color: rgba(255,255,255,0.4); margin-bottom: 4px; }
.setting-group input {
  width: 100%;
  padding: 6px 8px;
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.12);
  background: rgba(255,255,255,0.05);
  color: #e0e0e0;
  font-size: 14px;
  outline: none;
}
.setting-group input:focus { border-color: #7b8abd; }
.quick-btns { display: flex; gap: 4px; margin-top: 4px; }
.quick-btns button {
  flex: 1;
  padding: 6px 4px;
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 6px;
  background: transparent;
  color: rgba(255,255,255,0.5);
  font-size: 11px;
  cursor: pointer;
}
.quick-btns button:hover { background: rgba(255,255,255,0.06); }
.quick-btns button.selected { border-color: #7b8abd; background: rgba(123,138,189,0.15); color: #c8cad0; }

.order-info {
  font-size: 12px;
  color: rgba(255,255,255,0.4);
  text-align: center;
  padding: 4px 0;
}
.order-info span { color: #c8cad0; font-weight: 600; }

/* ãƒã‚¸ã‚·ãƒ§ãƒ³ */
.positions-list { max-height: 180px; overflow-y: auto; }
.position-item {
  background: rgba(255,255,255,0.03);
  border-radius: 8px;
  padding: 8px 10px;
  margin-bottom: 4px;
  font-size: 12px;
  border-left: 3px solid transparent;
}
.pos-header { display: flex; justify-content: space-between; align-items: center; }
.pos-ticker { font-weight: 700; font-size: 13px; color: #c8cad0; }
.pos-pnl { font-weight: 600; }
.pos-details { display: flex; justify-content: space-between; margin-top: 3px; color: rgba(255,255,255,0.4); font-size: 11px; }
.btn-close-pos {
  padding: 5px 12px;
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: 6px;
  background: transparent;
  color: #c8cad0;
  font-size: 12px;
  cursor: pointer;
  margin-left: 6px;
}
.btn-close-pos:hover { background: rgba(255,255,255,0.08); }

/* å–å¼•å±¥æ­´ */
.history-list { max-height: 120px; overflow-y: auto; }
.history-item {
  font-size: 11px;
  padding: 4px 0;
  border-bottom: 1px solid rgba(255,255,255,0.04);
  display: flex;
  justify-content: space-between;
  color: rgba(255,255,255,0.6);
}
.h-action { font-weight: 600; }

.no-positions { text-align: center; padding: 16px; color: rgba(255,255,255,0.25); font-size: 12px; }

/* ========== é–‹å§‹ç”»é¢ ========== */
.start-screen {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: #1a1d2e;
  display: flex; align-items: center; justify-content: center;
  z-index: 1000; transition: opacity 0.5s;
  overflow-y: auto;
}
.start-screen.hidden { opacity: 0; pointer-events: none; }
.start-content { text-align: center; max-width: 440px; padding: 32px 20px; }
.start-content .logo-big { font-size: 48px; margin-bottom: 12px; }
.start-content h1 { font-size: 26px; font-weight: 800; color: #d0d2d8; }
.start-content p { color: rgba(255,255,255,0.5); margin-bottom: 20px; font-size: 14px; }
.start-content .rules {
  text-align: left; background: rgba(255,255,255,0.04);
  border-radius: 12px; padding: 14px; margin-bottom: 20px;
}
.start-content .rules h3 { margin-bottom: 8px; font-size: 14px; color: #c8cad0; }
.start-content .rules li { margin-bottom: 5px; padding-left: 6px; font-size: 13px; color: rgba(255,255,255,0.6); list-style: none; }
.start-content .rules li::before { content: 'â€¢ '; color: #7b8abd; }
.color-select { display: flex; gap: 8px; justify-content: center; margin-bottom: 16px; }
.color-select button {
  padding: 8px 14px; border: 2px solid rgba(255,255,255,0.15); border-radius: 10px;
  background: transparent; color: #c8cad0; font-size: 13px; font-weight: 600; cursor: pointer;
  display: flex; align-items: center; gap: 6px;
}
.color-select button.selected { border-color: #7b8abd; background: rgba(123,138,189,0.15); }
.color-select button:hover { border-color: #7b8abd; }
.color-swatch {
  display: inline-flex; gap: 3px; align-items: center;
}
.color-swatch span {
  display: inline-block; width: 10px; height: 10px; border-radius: 2px;
}
.color-select-label { font-size: 12px; color: rgba(255,255,255,0.4); margin-bottom: 6px; text-align: center; }
.time-select { display: flex; gap: 8px; justify-content: center; margin-bottom: 16px; }
.time-select button {
  padding: 8px 18px; border: 2px solid rgba(255,255,255,0.15); border-radius: 10px;
  background: transparent; color: #c8cad0; font-size: 14px; font-weight: 600; cursor: pointer;
}
.time-select button.selected { border-color: #7b8abd; background: rgba(123,138,189,0.15); }
.time-select button:hover { border-color: #7b8abd; }
.btn-start {
  padding: 14px 48px; border: none; border-radius: 12px;
  background: linear-gradient(135deg, #6a7bbd, #5568a8);
  color: #fff; font-size: 17px; font-weight: 700; cursor: pointer;
  transition: all 0.2s;
}
.btn-start:hover { transform: scale(1.03); box-shadow: 0 6px 24px rgba(106,123,189,0.3); }
.btn-start:disabled { opacity: 0.5; transform: none; cursor: not-allowed; }

/* ========== ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ========== */
.countdown-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
  display: flex; align-items: center; justify-content: center;
  z-index: 999; opacity: 0; pointer-events: none;
  transition: opacity 0.2s;
}
.countdown-overlay.show { opacity: 1; pointer-events: auto; }
.countdown-text {
  font-size: 64px; font-weight: 800; color: #e8c56a;
  animation: countPulse 0.6s ease-out;
}
@keyframes countPulse {
  0% { transform: scale(1.5); opacity: 0; }
  50% { transform: scale(1.1); opacity: 1; }
  100% { transform: scale(1); opacity: 1; }
}

/* ========== çµæœç”»é¢ ========== */
.result-screen {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.75); backdrop-filter: blur(8px);
  display: none; align-items: center; justify-content: center; z-index: 1000;
}
.result-screen.show { display: flex; }
.result-content {
  text-align: center; max-width: 400px; padding: 36px 24px;
  background: rgba(40,44,60,0.95); border-radius: 18px; border: 1px solid rgba(255,255,255,0.08);
}
.result-content .result-icon { font-size: 48px; margin-bottom: 10px; }
.result-content h2 { font-size: 22px; margin-bottom: 6px; color: #d0d2d8; }
.result-amount { font-size: 32px; font-weight: 800; margin: 10px 0; }
.result-amount.positive { color: var(--color-up); }
.result-amount.negative { color: var(--color-down); }
.result-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 16px 0; }
.result-stat { background: rgba(255,255,255,0.04); border-radius: 10px; padding: 10px; }
.result-stat .rs-label { font-size: 11px; color: rgba(255,255,255,0.4); }
.result-stat .rs-value { font-size: 15px; font-weight: 700; margin-top: 3px; color: #c8cad0; }
.btn-restart {
  padding: 12px 36px; border: none; border-radius: 10px;
  background: linear-gradient(135deg, #6a7bbd, #5568a8);
  color: #fff; font-size: 15px; font-weight: 700; cursor: pointer;
}
.btn-restart:hover { transform: scale(1.03); }

/* ========== ãƒˆãƒ¼ã‚¹ãƒˆ ========== */
.toast-container { position: fixed; top: 56px; right: 12px; z-index: 500; display: flex; flex-direction: column; gap: 6px; }
.toast {
  padding: 10px 16px; border-radius: 10px; font-size: 13px; font-weight: 600;
  animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
  color: #e0e0e0;
}
.toast.success { background: rgba(var(--color-up-rgb),0.15); border: 1px solid rgba(var(--color-up-rgb),0.4); }
.toast.error { background: rgba(var(--color-down-rgb),0.15); border: 1px solid rgba(var(--color-down-rgb),0.4); }
.toast.info { background: rgba(123,138,189,0.15); border: 1px solid rgba(123,138,189,0.4); }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes fadeOut { to { opacity: 0; } }

/* ========== ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ ========== */
@media (max-width: 1100px) {
  .main {
    grid-template-columns: 1fr;
    grid-template-rows: auto 1fr auto;
    height: auto;
    overflow-y: auto;
    padding-bottom: 20px;
  }
  .stock-list { max-height: 160px; }
  .chart-canvas-container { min-height: 280px; }
}

/* ========== ã‚¹ãƒãƒ› ========== */
@media (max-width: 640px) {
  body { overflow: auto; }

  .header {
    flex-direction: column;
    height: auto;
    padding: 8px 12px;
    gap: 6px;
  }
  .header-left h1 { font-size: 14px; }
  .header-right {
    width: 100%;
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 1fr;
    gap: 4px;
  }
  .stat-box { padding: 3px 4px; }
  .stat-box .label { font-size: 9px; }
  .stat-box .value { font-size: 12px; }

  .main {
    grid-template-columns: 1fr;
    height: auto;
    overflow-y: auto;
    gap: 8px;
    padding: 8px;
    padding-bottom: 24px;
  }

  .stock-list {
    padding: 8px;
    max-height: none;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
  }
  .stock-list h2 { font-size: 11px; margin-bottom: 6px; }
  #stockListContainer {
    display: flex;
    gap: 6px;
    overflow-x: auto;
    padding-bottom: 4px;
    -webkit-overflow-scrolling: touch;
  }
  .stock-item {
    min-width: 140px;
    flex-shrink: 0;
    margin-bottom: 0;
    padding: 6px 8px;
  }
  .stock-item .stock-name { font-size: 12px; }
  .stock-item .stock-ticker { font-size: 10px; }
  .stock-item .stock-price { font-size: 13px; }
  .stock-item .stock-change { font-size: 10px; }
  .si-row { flex-direction: column; align-items: flex-start; gap: 2px; }

  .chart-area { padding: 10px 8px; }
  .chart-header .stock-info h2 { font-size: 14px; }
  .chart-header .stock-info .current-price { font-size: 20px; }
  .chart-header .stock-info .price-change { font-size: 12px; }
  .chart-canvas-container { min-height: 220px; }

  .trade-panel { gap: 6px; }
  .panel-card { padding: 10px; }
  .panel-card h3 { font-size: 11px; }

  .trade-settings { flex-direction: column; gap: 6px; }
  .setting-group input { padding: 10px; font-size: 16px; }
  .quick-btns { gap: 6px; margin-top: 6px; }
  .quick-btns button {
    padding: 10px 4px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 8px;
    min-height: 40px;
  }
  .btn-trade { padding: 16px 8px; font-size: 17px; border-radius: 12px; min-height: 52px; }

  .position-item { padding: 10px 12px; }
  .pos-ticker { font-size: 14px; }
  .pos-pnl { font-size: 14px; }
  .btn-close-pos {
    padding: 8px 16px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 8px;
    min-height: 36px;
  }
  .pos-details { font-size: 12px; margin-top: 6px; }

  .toast-container { right: 8px; left: 8px; }
  .toast { font-size: 12px; padding: 8px 12px; }

  .start-content { padding: 24px 16px; }
  .start-content .logo-big { font-size: 40px; }
  .start-content h1 { font-size: 22px; }
  .start-content p { font-size: 13px; }
  .start-content .rules { padding: 12px; }
  .start-content .rules li { font-size: 12px; }
  .time-select button { padding: 6px 14px; font-size: 13px; }
  .color-select button { padding: 6px 10px; font-size: 12px; }
  .color-select-label { font-size: 11px; }
  .btn-start { padding: 12px 40px; font-size: 16px; }

  .result-content { padding: 28px 16px; margin: 16px; }
  .result-content .result-icon { font-size: 40px; }
  .result-content h2 { font-size: 20px; }
  .result-amount { font-size: 28px; }

  .countdown-text { font-size: 48px; }
}

/* ========== æˆç¸¾ãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ ========== */
.nav-btns-start { display: flex; gap: 8px; justify-content: center; margin-bottom: 16px; }
.btn-nav {
  padding: 10px 20px; border: 2px solid rgba(255,255,255,0.15); border-radius: 10px;
  background: transparent; color: #c8cad0; font-size: 13px; font-weight: 600; cursor: pointer;
  display: flex; align-items: center; gap: 6px; transition: all 0.15s;
}
.btn-nav:hover { border-color: #7b8abd; background: rgba(123,138,189,0.1); }
.overlay-screen {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
  display: none; align-items: flex-start; justify-content: center;
  z-index: 1001; overflow-y: auto; padding: 24px 16px;
}
.overlay-screen.show { display: flex; }
.overlay-inner {
  width: 100%; max-width: 520px; margin: auto;
  background: rgba(40,44,60,0.97); border-radius: 18px;
  border: 1px solid rgba(255,255,255,0.08); padding: 24px;
}
.overlay-header {
  display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;
}
.overlay-header h2 { font-size: 18px; font-weight: 700; color: #d0d2d8; }
.btn-overlay-close {
  width: 32px; height: 32px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);
  background: transparent; color: #c8cad0; font-size: 18px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}
.btn-overlay-close:hover { background: rgba(255,255,255,0.06); }
.period-tabs { display: flex; gap: 4px; margin-bottom: 16px; }
.period-tab {
  flex: 1; padding: 8px 6px; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;
  background: transparent; color: rgba(255,255,255,0.5); font-size: 12px; font-weight: 600;
  cursor: pointer; text-align: center;
}
.period-tab.active { border-color: #7b8abd; background: rgba(123,138,189,0.15); color: #c8cad0; }
.pnl-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px; }
.pnl-card {
  background: rgba(255,255,255,0.04); border-radius: 10px; padding: 12px; text-align: center;
}
.pnl-card .pc-label { font-size: 11px; color: rgba(255,255,255,0.4); margin-bottom: 4px; }
.pnl-card .pc-value { font-size: 18px; font-weight: 700; color: #c8cad0; }
.pnl-card .pc-value.up { color: var(--color-up); }
.pnl-card .pc-value.down { color: var(--color-down); }
.pnl-card .pc-sub { font-size: 11px; color: rgba(255,255,255,0.35); margin-top: 2px; }
.ranking-table { width: 100%; }
.ranking-header {
  display: grid; grid-template-columns: 40px 1fr 100px 60px;
  padding: 6px 8px; font-size: 11px; color: rgba(255,255,255,0.4);
  border-bottom: 1px solid rgba(255,255,255,0.08);
}
.ranking-row {
  display: grid; grid-template-columns: 40px 1fr 100px 60px;
  padding: 8px; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.04);
  align-items: center;
}
.ranking-row.self { background: rgba(123,138,189,0.12); border-radius: 8px; }
.ranking-row .rank { font-weight: 700; color: rgba(255,255,255,0.6); }
.ranking-row .rank.top-1 { color: #e8c56a; }
.ranking-row .rank.top-2 { color: #b0b8c8; }
.ranking-row .rank.top-3 { color: #c4956a; }
.ranking-row .r-name { color: #c8cad0; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.ranking-row .r-pnl { font-weight: 700; text-align: right; }
.ranking-row .r-pnl.up { color: var(--color-up); }
.ranking-row .r-pnl.down { color: var(--color-down); }
.ranking-row .r-trades { text-align: right; color: rgba(255,255,255,0.4); font-size: 12px; }
.ranking-empty { text-align: center; padding: 32px; color: rgba(255,255,255,0.25); font-size: 13px; }
.status-msg {
  text-align: center; padding: 10px; border-radius: 8px; font-size: 12px; margin-bottom: 12px;
}
.status-msg.warning {
  background: rgba(232,197,106,0.1); border: 1px solid rgba(232,197,106,0.3); color: #e8c56a;
}
.status-msg.error {
  background: rgba(224,114,114,0.1); border: 1px solid rgba(224,114,114,0.3); color: #e07272;
}
.save-status { font-size: 11px; margin-top: 10px; color: rgba(255,255,255,0.4); }
.save-status.ok { color: #6ec77a; }
.save-status.fail { color: #e07272; }
.result-nav { display: flex; gap: 8px; justify-content: center; margin-top: 12px; }
.result-nav .btn-nav { padding: 8px 14px; font-size: 12px; }
.stats-detail-section { margin-bottom: 16px; }
.stats-detail-section h3 { font-size: 13px; color: rgba(255,255,255,0.5); margin-bottom: 8px; }
.stats-detail-row {
  display: flex; justify-content: space-between; padding: 6px 0;
  border-bottom: 1px solid rgba(255,255,255,0.04); font-size: 13px;
}
.stats-detail-row .sd-label { color: rgba(255,255,255,0.5); }
.stats-detail-row .sd-value { color: #c8cad0; font-weight: 600; }
@media (max-width: 640px) {
  .overlay-inner { padding: 16px; }
  .overlay-header h2 { font-size: 16px; }
  .pnl-card .pc-value { font-size: 16px; }
  .ranking-row { font-size: 12px; padding: 6px; }
  .ranking-header { font-size: 10px; }
  .btn-nav { padding: 8px 14px; font-size: 12px; }
  .nav-btns-start { flex-direction: column; align-items: center; }
}
</style>
</head>
<body>

<!-- é–‹å§‹ç”»é¢ -->
<div class="start-screen" id="startScreen">
  <div class="start-content">
    <div class="logo-big">ğŸ“ˆ</div>
    <h1>æ ªãƒˆãƒ¬ãƒ¼ãƒ‰ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
    <p>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«å¤‰å‹•ã™ã‚‹æ ªä¾¡ã§å£²è²·ã—ã¦åˆ©ç›Šã‚’ç›®æŒ‡ãã†ï¼</p>
    <div class="rules">
      <h3>ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ«</h3>
      <ul>
        <li>åˆæœŸè³‡é‡‘ Â¥1,000,000 ã§ã‚¹ã‚¿ãƒ¼ãƒˆ</li>
        <li>6ã¤ã®éŠ˜æŸ„ã‹ã‚‰ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å£²è²·</li>
        <li>è²·ã„ï¼ˆãƒ­ãƒ³ã‚°ï¼‰ã‚‚ç©ºå£²ã‚Šï¼ˆã‚·ãƒ§ãƒ¼ãƒˆï¼‰ã‚‚OK</li>
        <li>ãƒ¬ãƒãƒ¬ãƒƒã‚¸ï¼ˆ1ã€œ5å€ï¼‰ã§ãƒªã‚¹ã‚¯èª¿æ•´</li>
        <li>åˆ¶é™æ™‚é–“å†…ã«æœ€å¤§åˆ©ç›Šã‚’ç›®æŒ‡ã›ï¼</li>
        <li>é•·ã„åˆ¶é™æ™‚é–“ã»ã©æ ªä¾¡ã¯ã‚†ã£ãã‚Šå‹•ã</li>
      </ul>
    </div>
    <div class="time-select" id="timeSelect">
      <button data-time="180" class="selected">3åˆ†</button>
      <button data-time="300">5åˆ†</button>
      <button data-time="600">10åˆ†</button>
    </div>
    <div class="color-select-label">ãƒãƒ£ãƒ¼ãƒˆã®é…è‰²</div>
    <div class="color-select" id="colorSelect">
      <button data-mode="normal" class="selected">
        <div class="color-swatch"><span style="background:#6ec77a"></span><span style="background:#e07272"></span></div>
        ç·‘â†‘ èµ¤â†“
      </button>
      <button data-mode="reverse">
        <div class="color-swatch"><span style="background:#e07272"></span><span style="background:#6ec77a"></span></div>
        èµ¤â†‘ ç·‘â†“
      </button>
    </div>
    <button class="btn-start" id="btnStart">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
    <div class="nav-btns-start">
      <button class="btn-nav" id="btnOpenStats">ğŸ“Š æˆç¸¾</button>
      <button class="btn-nav" id="btnOpenRanking">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
    </div>
  </div>
</div>

<!-- ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div class="countdown-overlay" id="countdownOverlay">
  <div class="countdown-text" id="countdownText">Ready</div>
</div>

<!-- çµæœç”»é¢ -->
<div class="result-screen" id="resultScreen">
  <div class="result-content">
    <div class="result-icon" id="resultIcon">ğŸ†</div>
    <h2 id="resultTitle">ã‚²ãƒ¼ãƒ çµ‚äº†ï¼</h2>
    <div class="result-amount" id="resultAmount"></div>
    <div class="result-stats">
      <div class="result-stat"><div class="rs-label">æœ€çµ‚è³‡ç”£</div><div class="rs-value" id="rsFinalAsset">-</div></div>
      <div class="result-stat"><div class="rs-label">æ±ºæ¸ˆå›æ•°</div><div class="rs-value" id="rsTradeCount">-</div></div>
      <div class="result-stat"><div class="rs-label">å‹ç‡</div><div class="rs-value" id="rsWinRate">-</div></div>
      <div class="result-stat"><div class="rs-label">æœ€å¤§åˆ©ç›Š</div><div class="rs-value" id="rsMaxProfit">-</div></div>
    </div>
    <button class="btn-restart" id="btnRestart">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
    <div class="save-status" id="saveStatus"></div>
    <div class="result-nav">
      <button class="btn-nav" id="btnResultStats">ğŸ“Š æˆç¸¾</button>
      <button class="btn-nav" id="btnResultRanking">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
    </div>
  </div>
</div>

<!-- æˆç¸¾ç”»é¢ -->
<div class="overlay-screen" id="statsScreen">
  <div class="overlay-inner">
    <div class="overlay-header">
      <h2>ğŸ“Š å–å¼•æˆç¸¾</h2>
      <button class="btn-overlay-close" id="btnCloseStats">&times;</button>
    </div>
    <div id="statsStorageStatus"></div>
    <div id="statsContent"></div>
  </div>
</div>

<!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ -->
<div class="overlay-screen" id="rankingScreen">
  <div class="overlay-inner">
    <div class="overlay-header">
      <h2>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
      <button class="btn-overlay-close" id="btnCloseRanking">&times;</button>
    </div>
    <div class="status-msg warning">ãƒ­ãƒ¼ã‚«ãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆã“ã®ç«¯æœ«ã®ã¿ï¼‰: ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°æœªå¯¾å¿œ â€” ã‚µãƒ¼ãƒåŒæœŸä¸å¯ã®ãŸã‚ãƒ©ãƒ³ã‚­ãƒ³ã‚°å‚åŠ ã¯ã“ã®ç«¯æœ«ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã§ã™</div>
    <div id="rankingStorageStatus"></div>
    <div class="period-tabs" id="rankingPeriodTabs">
      <button class="period-tab active" data-period="ALL">å…¨æœŸé–“</button>
      <button class="period-tab" data-period="WEEKLY">é€±æ¬¡</button>
      <button class="period-tab" data-period="MONTHLY">æœˆæ¬¡</button>
      <button class="period-tab" data-period="DAILY">æ—¥æ¬¡</button>
    </div>
    <div id="rankingContent"></div>
  </div>
</div>

<!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
<div class="header">
  <div class="header-left"><span class="logo">ğŸ“Š</span><h1>Stock Trader</h1></div>
  <div class="header-right">
    <div class="stat-box timer-box"><div class="label">æ®‹ã‚Šæ™‚é–“</div><div class="value" id="timerDisplay">03:00</div></div>
    <div class="stat-box"><div class="label">ç·è³‡ç”£</div><div class="value" id="totalAssetDisplay">Â¥1,000,000</div></div>
    <div class="stat-box"><div class="label">ç¾é‡‘</div><div class="value" id="cashDisplay">Â¥1,000,000</div></div>
    <div class="stat-box"><div class="label">ç¢ºå®šæç›Š</div><div class="value" id="pnlDisplay">Â¥0</div></div>
  </div>
</div>

<div class="main">
  <div class="stock-list">
    <h2>éŠ˜æŸ„ä¸€è¦§</h2>
    <div id="stockListContainer"></div>
  </div>

  <div class="chart-area">
    <div class="chart-header">
      <div class="stock-info">
        <h2 id="chartStockName">-</h2>
        <div class="current-price" id="chartPrice">-</div>
        <div class="price-change" id="chartChange">-</div>
      </div>
    </div>
    <div class="chart-canvas-container">
      <canvas id="priceChart"></canvas>
    </div>
  </div>

  <div class="trade-panel">
    <div class="panel-card">
      <h3>æ³¨æ–‡</h3>
      <div class="trade-settings">
        <div class="setting-group">
          <label>æ•°é‡</label>
          <input type="number" id="orderQuantity" value="100" min="1" step="10">
          <div class="quick-btns">
            <button onclick="setQuantity(10)">10</button>
            <button onclick="setQuantity(50)">50</button>
            <button onclick="setQuantity(100)">100</button>
            <button onclick="setQuantity(500)">500</button>
          </div>
        </div>
        <div class="setting-group">
          <label>ãƒ¬ãƒãƒ¬ãƒƒã‚¸</label>
          <div class="quick-btns" id="leverageBtns" style="margin-top:0;">
            <button class="selected" onclick="setLeverage(1)">1x</button>
            <button onclick="setLeverage(2)">2x</button>
            <button onclick="setLeverage(3)">3x</button>
            <button onclick="setLeverage(5)">5x</button>
          </div>
        </div>
      </div>
      <div class="order-info">
        å¿…è¦è³‡é‡‘: <span id="osTotal">-</span>
      </div>
      <div class="trade-buttons">
        <button class="btn-trade buy-btn" onclick="executeOrder('buy')">è²·ã„</button>
        <button class="btn-trade sell-btn" onclick="executeOrder('sell')">ç©ºå£²ã‚Š</button>
      </div>
    </div>

    <div class="panel-card">
      <h3>ä¿æœ‰ãƒã‚¸ã‚·ãƒ§ãƒ³</h3>
      <div class="positions-list" id="positionsList">
        <div class="no-positions">ãƒã‚¸ã‚·ãƒ§ãƒ³ãªã—</div>
      </div>
    </div>

    <div class="panel-card">
      <h3>å–å¼•å±¥æ­´</h3>
      <div class="history-list" id="historyList">
        <div class="no-positions">ã¾ã å–å¼•ãŒã‚ã‚Šã¾ã›ã‚“</div>
      </div>
    </div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
// ==================== å®šæ•° ====================
const STOCKS = [
  { ticker: 'TNET', name: 'ãƒ†ãƒƒã‚¯ãƒãƒƒãƒˆ', sector: 'IT', basePrice: 8500, volatility: 0.015, trend: 0.0002 },
  { ticker: 'GFIN', name: 'ã‚°ãƒ­ãƒ¼ãƒãƒ«é‡‘è', sector: 'é‡‘è', basePrice: 3200, volatility: 0.01, trend: -0.0001 },
  { ticker: 'MEDI', name: 'ãƒ¡ãƒ‡ã‚£ãƒ©ã‚¤ãƒ•', sector: 'åŒ»è–¬å“', basePrice: 5800, volatility: 0.012, trend: 0.00015 },
  { ticker: 'ENRG', name: 'ã‚¨ãƒŠã‚¸ãƒ¼ãƒ‘ãƒ¯ãƒ¼', sector: 'ã‚¨ãƒãƒ«ã‚®ãƒ¼', basePrice: 2100, volatility: 0.018, trend: 0.0001 },
  { ticker: 'FOOD', name: 'ãƒ•ãƒ¼ãƒ‰ãƒ‡ãƒª', sector: 'é£Ÿå“', basePrice: 4500, volatility: 0.008, trend: 0.00005 },
  { ticker: 'AUTO', name: 'ã‚ªãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ†ã‚£ãƒ–', sector: 'è‡ªå‹•è»Š', basePrice: 6800, volatility: 0.014, trend: -0.00008 },
];

const TIME_CONFIGS = {
  180:  { volScale: 1.0,  tickMs: 300 },
  300:  { volScale: 0.6,  tickMs: 400 },
  600:  { volScale: 0.35, tickMs: 500 },
};

// ãƒ­ãƒ¼ã‚½ã‚¯è¶³è¨­å®š
const CANDLE_INTERVAL_MS = 1000; // 1ç§’è¶³
const MAX_CANDLES = 80;          // æœ€å¤§è¡¨ç¤ºæœ¬æ•°

// ==================== ã‚²ãƒ¼ãƒ çŠ¶æ…‹ (state machine) ====================
// states: 'idle' | 'starting' | 'running' | 'ended'
const gameState = {
  phase: 'idle',
  running: false,       // running ã®äº’æ›ï¼ˆphase==='running' ã¨åŒæœŸï¼‰
  cash: 1000000,
  initialCash: 1000000,
  realizedPnl: 0,
  positions: [],
  history: [],
  timeLeft: 180,
  totalTime: 180,
  selectedStock: 0,
  leverage: 1,
  settlementCount: 0,
  winCount: 0,
  maxProfit: 0,
  marketColorMode: 'RISE_GREEN',
};

let stockData = {};
let priceHistories = {};  // tickå˜ä½ï¼ˆå†…éƒ¨ç”¨ï¼‰
let candleData = {};      // éŠ˜æŸ„ã”ã¨ã®ãƒ­ãƒ¼ã‚½ã‚¯è¶³é…åˆ—
let currentCandle = {};   // éŠ˜æŸ„ã”ã¨ã®å½¢æˆä¸­ãƒ­ãƒ¼ã‚½ã‚¯è¶³
let candleStartTime = 0;  // ç¾åœ¨ã®è¶³ã®é–‹å§‹æ™‚åˆ»

let tickInterval = null;
let timerInterval = null;
let rafId = null;
let startDelayTimer = null;
let needsRender = true;

// è‰²ãƒ¢ãƒ¼ãƒ‰ï¼ˆCSSå¤‰æ•°ã‹ã‚‰å‹•çš„å–å¾—ï¼‰
function getUpColor() { return getComputedStyle(document.documentElement).getPropertyValue('--color-up').trim(); }
function getDownColor() { return getComputedStyle(document.documentElement).getPropertyValue('--color-down').trim(); }
function getUpRGB() { return getComputedStyle(document.documentElement).getPropertyValue('--color-up-rgb').trim(); }
function getDownRGB() { return getComputedStyle(document.documentElement).getPropertyValue('--color-down-rgb').trim(); }

// ãƒ†ãƒ¼ãƒå¤‰æ•°ï¼ˆå›ºå®šè‰²ï¼‰
const theme = {
  positive: '#6ec77a',
  negative: '#e07272',
  positiveRGB: '110,199,122',
  negativeRGB: '224,114,114',
};

// å£²è²·æ–¹å‘ã«åŸºã¥ãè‰²ã‚’è¿”ã™
// side: "BUY" | "SELL" ã®ã¿è¨±å¯
// marketColorMode: "RISE_GREEN" | "RISE_RED"
function getTradeColor(side, marketColorMode) {
  if (side !== 'BUY' && side !== 'SELL') {
    throw new Error('side must be "BUY" or "SELL"');
  }
  if (marketColorMode === 'RISE_GREEN') {
    return side === 'BUY' ? theme.positive : theme.negative;
  }
  if (marketColorMode === 'RISE_RED') {
    return side === 'BUY' ? theme.negative : theme.positive;
  }
  return theme.positive;
}

function getTradeColorRGB(side, marketColorMode) {
  if (side !== 'BUY' && side !== 'SELL') {
    throw new Error('side must be "BUY" or "SELL"');
  }
  if (marketColorMode === 'RISE_GREEN') {
    return side === 'BUY' ? theme.positiveRGB : theme.negativeRGB;
  }
  if (marketColorMode === 'RISE_RED') {
    return side === 'BUY' ? theme.negativeRGB : theme.positiveRGB;
  }
  return theme.positiveRGB;
}

// ==================== ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å±¤ ====================
const STORAGE_KEYS = {
  TRADES: 'stock_game_trades',
  USER_ID: 'stock_game_user_id',
  USER_NAME: 'stock_game_user_name',
  GAME_RESULTS: 'stock_game_results',
};

let storageAvailable = false;

function checkStorageAvailability() {
  try {
    const test = '__storage_test__';
    localStorage.setItem(test, test);
    localStorage.removeItem(test);
    storageAvailable = true;
  } catch (e) {
    storageAvailable = false;
  }
  return storageAvailable;
}

function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
}

function getLocalUserId() {
  if (!storageAvailable) return null;
  let id = localStorage.getItem(STORAGE_KEYS.USER_ID);
  if (!id) {
    id = 'user_' + generateId();
    localStorage.setItem(STORAGE_KEYS.USER_ID, id);
  }
  return id;
}

function getLocalUserName() {
  if (!storageAvailable) return 'ä¸æ˜';
  return localStorage.getItem(STORAGE_KEYS.USER_NAME) || ('User#' + (getLocalUserId() || '').slice(-4));
}

// --- Trade Storage ---
function saveTrade(trade) {
  if (!storageAvailable) return false;
  try {
    const trades = getAllTrades();
    trades.push(trade);
    localStorage.setItem(STORAGE_KEYS.TRADES, JSON.stringify(trades));
    return true;
  } catch (e) {
    console.error('Trade save failed:', e);
    return false;
  }
}

function getAllTrades() {
  if (!storageAvailable) return [];
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEYS.TRADES) || '[]');
  } catch (e) {
    return [];
  }
}

// --- Game Result Storage ---
function saveGameResult(result) {
  if (!storageAvailable) return false;
  try {
    const results = getAllGameResults();
    results.push(result);
    localStorage.setItem(STORAGE_KEYS.GAME_RESULTS, JSON.stringify(results));
    return true;
  } catch (e) {
    console.error('Game result save failed:', e);
    return false;
  }
}

function getAllGameResults() {
  if (!storageAvailable) return [];
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEYS.GAME_RESULTS) || '[]');
  } catch (e) {
    return [];
  }
}

// --- Period Key Calculation ---
function getPeriodKey(dateStr, periodType) {
  const d = new Date(dateStr);
  if (isNaN(d.getTime())) return null;
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  switch (periodType) {
    case 'DAILY':
      return `${yyyy}-${mm}-${dd}`;
    case 'WEEKLY': {
      const tmp = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = tmp.getUTCDay() || 7;
      tmp.setUTCDate(tmp.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(tmp.getUTCFullYear(), 0, 1));
      const week = Math.ceil((((tmp - yearStart) / 86400000) + 1) / 7);
      return `${tmp.getUTCFullYear()}-W${String(week).padStart(2, '0')}`;
    }
    case 'MONTHLY':
      return `${yyyy}-${mm}`;
    case 'ALL':
      return 'ALL';
    default:
      return 'ALL';
  }
}

// --- PnL Calculation from Trades ---
function calculatePnlFromTrades(trades) {
  let realizedPnl = 0, tradeCount = 0, winCount = 0, loseCount = 0;
  for (const t of trades) {
    if (t.action === 'CLOSE' && typeof t.pnlDelta === 'number') {
      realizedPnl += t.pnlDelta;
      tradeCount++;
      if (t.pnlDelta > 0) winCount++;
      else if (t.pnlDelta < 0) loseCount++;
    }
  }
  return { realizedPnl, tradeCount, winCount, loseCount };
}

// --- Ranking ---
function getRanking(periodType) {
  if (!storageAvailable) return { error: 'å–å¾—ä¸å¯: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“', data: [] };
  const results = getAllGameResults();
  if (results.length === 0) return { error: null, data: [] };
  const now = new Date();
  const currentKey = getPeriodKey(now.toISOString(), periodType);
  const filtered = periodType === 'ALL'
    ? results
    : results.filter(r => {
        const key = getPeriodKey(r.completedAt, periodType);
        return key !== null && key === currentKey;
      });
  // Sort: realizedPnl desc â†’ tradeCount asc â†’ earlier completedAt
  filtered.sort((a, b) => {
    if (b.realizedPnl !== a.realizedPnl) return b.realizedPnl - a.realizedPnl;
    if (a.tradeCount !== b.tradeCount) return a.tradeCount - b.tradeCount;
    return new Date(a.completedAt) - new Date(b.completedAt);
  });
  return { error: null, data: filtered.slice(0, 100) };
}

// --- Stats Summary ---
function getStatsSummary() {
  if (!storageAvailable) return { error: 'å–å¾—ä¸å¯: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“', summaries: {} };
  const trades = getAllTrades();
  const now = new Date();
  const periods = ['DAILY', 'WEEKLY', 'MONTHLY', 'ALL'];
  const summaries = {};
  for (const p of periods) {
    const key = getPeriodKey(now.toISOString(), p);
    const filtered = p === 'ALL'
      ? trades
      : trades.filter(t => {
          const tk = getPeriodKey(t.executedAt, p);
          return tk !== null && tk === key;
        });
    summaries[p] = {
      ...calculatePnlFromTrades(filtered),
      periodType: p,
      periodKey: key,
    };
  }
  const gameResults = getAllGameResults();
  return { error: null, summaries, totalGames: gameResults.length };
}

// DOM ã‚­ãƒ£ãƒƒã‚·ãƒ¥
const DOM = {};
function cacheDom() {
  DOM.timer = document.getElementById('timerDisplay');
  DOM.totalAsset = document.getElementById('totalAssetDisplay');
  DOM.cash = document.getElementById('cashDisplay');
  DOM.pnl = document.getElementById('pnlDisplay');
  DOM.chartName = document.getElementById('chartStockName');
  DOM.chartPrice = document.getElementById('chartPrice');
  DOM.chartChange = document.getElementById('chartChange');
  DOM.osTotal = document.getElementById('osTotal');
  DOM.stockList = document.getElementById('stockListContainer');
  DOM.positions = document.getElementById('positionsList');
  DOM.history = document.getElementById('historyList');
  DOM.canvas = document.getElementById('priceChart');
  DOM.ctx = DOM.canvas.getContext('2d');
  DOM.canvasContainer = DOM.canvas.parentElement;
  DOM.toasts = document.getElementById('toastContainer');
  DOM.countdown = document.getElementById('countdownOverlay');
  DOM.countdownText = document.getElementById('countdownText');
}

// ==================== åˆæœŸåŒ– ====================
function initStocks() {
  stockData = {};
  priceHistories = {};
  candleData = {};
  currentCandle = {};
  STOCKS.forEach(s => {
    const startPrice = s.basePrice * (0.9 + Math.random() * 0.2);
    stockData[s.ticker] = {
      ...s, price: startPrice, prevPrice: startPrice, openPrice: startPrice,
      high: startPrice, low: startPrice, momentum: 0,
      microTrend: (Math.random() - 0.5) * 0.001,
    };
    priceHistories[s.ticker] = [startPrice];
    // åˆæœŸãƒ­ãƒ¼ã‚½ã‚¯è¶³: é–‹å§‹ä¾¡æ ¼ã®ã¿ã®1æœ¬
    candleData[s.ticker] = [];
    currentCandle[s.ticker] = {
      open: startPrice, high: startPrice, low: startPrice, close: startPrice,
    };
  });
  candleStartTime = Date.now();
}

// ==================== ä¾¡æ ¼æ›´æ–° + ãƒ­ãƒ¼ã‚½ã‚¯è¶³ç”Ÿæˆ ====================
function updatePrices() {
  if (gameState.phase !== 'running') return;
  const config = TIME_CONFIGS[gameState.totalTime] || TIME_CONFIGS[180];
  const volScale = config.volScale;
  const now = Date.now();

  // è¶³ç¢ºå®šãƒã‚§ãƒƒã‚¯
  const candleElapsed = now - candleStartTime;
  const shouldFinalize = candleElapsed >= CANDLE_INTERVAL_MS;

  for (let i = 0; i < STOCKS.length; i++) {
    const s = STOCKS[i];
    const d = stockData[s.ticker];
    d.prevPrice = d.price;

    const noise = (Math.random() - 0.5) * 2 * d.volatility * volScale;
    d.momentum = d.momentum * 0.95 + noise * 0.05;

    let spike = 0;
    if (Math.random() < 0.005) spike = (Math.random() - 0.5) * d.volatility * volScale * 4;
    if (Math.random() < 0.02) d.microTrend = (Math.random() - 0.5) * 0.002 * volScale;

    const change = d.price * (noise + d.momentum + d.trend * volScale + d.microTrend + spike);
    d.price = Math.max(d.price * 0.5, d.price + change);
    d.price = Math.round(d.price * 10) / 10;

    if (d.price > d.high) d.high = d.price;
    if (d.price < d.low) d.low = d.price;

    // tickå±¥æ­´ï¼ˆå†…éƒ¨ç”¨ï¼‰
    const hist = priceHistories[s.ticker];
    hist.push(d.price);
    if (hist.length > 200) hist.shift();

    // å½¢æˆä¸­ãƒ­ãƒ¼ã‚½ã‚¯è¶³ã‚’æ›´æ–°
    const cc = currentCandle[s.ticker];
    cc.close = d.price;
    if (d.price > cc.high) cc.high = d.price;
    if (d.price < cc.low) cc.low = d.price;

    // è¶³ç¢ºå®š
    if (shouldFinalize) {
      candleData[s.ticker].push({ ...cc });
      if (candleData[s.ticker].length > MAX_CANDLES) {
        candleData[s.ticker].shift();
      }
      // æ–°ã—ã„è¶³ã‚’é–‹å§‹
      currentCandle[s.ticker] = {
        open: d.price, high: d.price, low: d.price, close: d.price,
      };
    }
  }

  if (shouldFinalize) {
    candleStartTime = now;
  }

  needsRender = true;
}

// ==================== æç”»ãƒ«ãƒ¼ãƒ— ====================
function renderLoop() {
  if (gameState.phase !== 'running') return;
  if (needsRender) {
    needsRender = false;
    updateStockListDOM();
    updateChartHeader();
    updateOrderInfo();
    updatePositionsDOM();
    updateAssetDisplay();
    drawCandlestickChart();
  }
  rafId = requestAnimationFrame(renderLoop);
}

// ==================== éŠ˜æŸ„ãƒªã‚¹ãƒˆ ====================
let stockItemEls = [];
function buildStockList() {
  DOM.stockList.innerHTML = '';
  stockItemEls = [];
  STOCKS.forEach((s, i) => {
    const item = document.createElement('div');
    item.className = 'stock-item';
    item.onclick = () => selectStock(i);
    item.innerHTML = `<div class="si-row"><div><div class="stock-name">${s.name}</div><div class="stock-ticker">${s.ticker} / ${s.sector}</div></div><div style="text-align:right"><div class="stock-price"></div><div class="stock-change"></div></div></div>`;
    DOM.stockList.appendChild(item);
    stockItemEls.push({
      el: item,
      priceEl: item.querySelector('.stock-price'),
      changeEl: item.querySelector('.stock-change'),
    });
  });
}

function updateStockListDOM() {
  for (let i = 0; i < STOCKS.length; i++) {
    const s = STOCKS[i];
    const d = stockData[s.ticker];
    const se = stockItemEls[i];
    if (!se) continue;
    const isUp = d.price >= d.openPrice;
    const changePct = ((d.price - d.openPrice) / d.openPrice * 100).toFixed(2);
    const changeAmt = (d.price - d.openPrice).toFixed(1);

    se.priceEl.textContent = `Â¥${d.price.toLocaleString()}`;
    se.changeEl.textContent = `${isUp ? 'â–²' : 'â–¼'} ${changeAmt > 0 ? '+' : ''}${changeAmt} (${changePct > 0 ? '+' : ''}${changePct}%)`;
    se.changeEl.className = `stock-change ${isUp ? 'up' : 'down'}`;

    const selected = i === gameState.selectedStock;
    if (selected && !se.el.classList.contains('selected')) se.el.classList.add('selected');
    else if (!selected && se.el.classList.contains('selected')) se.el.classList.remove('selected');
  }
}

function updateChartHeader() {
  const s = STOCKS[gameState.selectedStock];
  const d = stockData[s.ticker];
  if (!d) return;
  const isUp = d.price >= d.openPrice;
  const changePct = ((d.price - d.openPrice) / d.openPrice * 100).toFixed(2);
  const changeAmt = (d.price - d.openPrice).toFixed(1);

  DOM.chartName.textContent = `${s.name} (${s.ticker})`;
  DOM.chartPrice.textContent = `Â¥${d.price.toLocaleString()}`;
  DOM.chartChange.textContent = `${isUp ? 'â–²' : 'â–¼'} ${changeAmt > 0 ? '+' : ''}${changeAmt} (${changePct > 0 ? '+' : ''}${changePct}%)`;
  DOM.chartChange.className = `price-change ${isUp ? 'up' : 'down'}`;
}

// ==================== ãƒ­ãƒ¼ã‚½ã‚¯è¶³ãƒãƒ£ãƒ¼ãƒˆæç”» ====================
let lastCanvasW = 0, lastCanvasH = 0;

function drawCandlestickChart() {
  const ctx = DOM.ctx;
  const container = DOM.canvasContainer;
  const w = container.clientWidth;
  const h = container.clientHeight;
  if (w === 0 || h === 0) return;

  const dpr = window.devicePixelRatio || 1;
  if (lastCanvasW !== w || lastCanvasH !== h) {
    DOM.canvas.width = w * dpr;
    DOM.canvas.height = h * dpr;
    lastCanvasW = w;
    lastCanvasH = h;
  }
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  ctx.clearRect(0, 0, w, h);

  const s = STOCKS[gameState.selectedStock];
  const ticker = s.ticker;
  const finalized = candleData[ticker] || [];
  const forming = currentCandle[ticker];
  if (!forming) return;

  // ç¢ºå®šè¶³ + å½¢æˆä¸­ã®è¶³ã‚’çµåˆ
  const allCandles = [...finalized, forming];
  const len = allCandles.length;
  if (len === 0) return;

  // Yè»¸ãƒ¬ãƒ³ã‚¸ç®—å‡º
  let minP = Infinity, maxP = -Infinity;
  for (let i = 0; i < len; i++) {
    if (allCandles[i].low < minP) minP = allCandles[i].low;
    if (allCandles[i].high > maxP) maxP = allCandles[i].high;
  }
  const rangePad = (maxP - minP) * 0.08 || maxP * 0.01;
  minP -= rangePad;
  maxP += rangePad;
  const range = maxP - minP || 1;

  const pad = { top: 16, bottom: 20, left: 55, right: 16 };
  const cw = w - pad.left - pad.right;
  const ch = h - pad.top - pad.bottom;

  // Yåº§æ¨™ãƒ˜ãƒ«ãƒ‘ãƒ¼
  const yOf = (price) => pad.top + (1 - (price - minP) / range) * ch;

  // ã‚°ãƒªãƒƒãƒ‰
  ctx.strokeStyle = 'rgba(255,255,255,0.05)';
  ctx.lineWidth = 1;
  ctx.font = '10px -apple-system,sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,0.3)';
  ctx.textAlign = 'right';
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + (ch / 4) * i;
    ctx.beginPath();
    ctx.moveTo(pad.left, y);
    ctx.lineTo(w - pad.right, y);
    ctx.stroke();
    const priceLabel = maxP - (range / 4) * i;
    ctx.fillText(`Â¥${priceLabel.toFixed(0)}`, pad.left - 6, y + 3);
  }

  // ãƒ­ãƒ¼ã‚½ã‚¯è¶³æç”»
  const totalSlots = Math.max(len, 20); // æœ€ä½20ã‚¹ãƒ­ãƒƒãƒˆç¢ºä¿
  const slotWidth = cw / totalSlots;
  const bodyWidth = Math.max(2, Math.min(slotWidth * 0.7, 14));
  const wickWidth = Math.max(1, bodyWidth * 0.15);

  for (let i = 0; i < len; i++) {
    const c = allCandles[i];
    const x = pad.left + (i + 0.5) * slotWidth;
    const isUp = c.close >= c.open;
    const isForming = (i === len - 1);

    const bullColor = getUpColor();
    const bearColor = getDownColor();
    const color = isUp ? bullColor : bearColor;
    const alpha = isForming ? 0.7 : 1.0;

    ctx.globalAlpha = alpha;

    // ãƒ’ã‚²ï¼ˆä¸Šä¸‹ã®ç·šï¼‰
    const highY = yOf(c.high);
    const lowY = yOf(c.low);
    ctx.strokeStyle = color;
    ctx.lineWidth = wickWidth;
    ctx.beginPath();
    ctx.moveTo(x, highY);
    ctx.lineTo(x, lowY);
    ctx.stroke();

    // å®Ÿä½“
    const openY = yOf(c.open);
    const closeY = yOf(c.close);
    const bodyTop = Math.min(openY, closeY);
    const bodyH = Math.max(Math.abs(closeY - openY), 1);

    if (isUp) {
      // é™½ç·š: å¡—ã‚Šã¤ã¶ã—
      ctx.fillStyle = color;
      ctx.fillRect(x - bodyWidth / 2, bodyTop, bodyWidth, bodyH);
    } else {
      // é™°ç·š: å¡—ã‚Šã¤ã¶ã—
      ctx.fillStyle = color;
      ctx.fillRect(x - bodyWidth / 2, bodyTop, bodyWidth, bodyH);
    }

    ctx.globalAlpha = 1.0;
  }

  // ç¾åœ¨ä¾¡æ ¼ãƒ©ã‚¤ãƒ³ï¼ˆç‚¹ç·šï¼‰
  const currentPrice = stockData[ticker].price;
  const currentY = yOf(currentPrice);
  ctx.setLineDash([3, 3]);
  ctx.strokeStyle = 'rgba(255,255,255,0.3)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(pad.left, currentY);
  ctx.lineTo(w - pad.right, currentY);
  ctx.stroke();
  ctx.setLineDash([]);

  // ç¾åœ¨ä¾¡æ ¼ãƒ©ãƒ™ãƒ«ï¼ˆå³ç«¯ï¼‰
  ctx.fillStyle = 'rgba(255,255,255,0.6)';
  ctx.font = '10px -apple-system,sans-serif';
  ctx.textAlign = 'left';
  ctx.fillText(`Â¥${currentPrice.toFixed(0)}`, w - pad.right + 2, currentY + 3);

  // ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ³
  for (let pi = 0; pi < gameState.positions.length; pi++) {
    const pos = gameState.positions[pi];
    if (pos.ticker !== ticker) continue;
    const posY = yOf(pos.entryPrice);
    if (posY < pad.top - 10 || posY > pad.top + ch + 10) continue;
    const posSide = pos.type === 'buy' ? 'BUY' : 'SELL';
    const posColor = getTradeColor(posSide, gameState.marketColorMode);
    const posColorRGB = getTradeColorRGB(posSide, gameState.marketColorMode);
    ctx.setLineDash([5, 3]);
    ctx.strokeStyle = `rgba(${posColorRGB},0.6)`;
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(pad.left, posY);
    ctx.lineTo(w - pad.right, posY);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = posColor;
    ctx.font = '10px -apple-system,sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText(`${pos.type === 'buy' ? 'è²·' : 'å£²'} Â¥${pos.entryPrice.toFixed(0)}`, pad.left + 4, posY - 4);
  }
}

// ==================== æ³¨æ–‡æƒ…å ± ====================
function updateOrderInfo() {
  const s = STOCKS[gameState.selectedStock];
  const d = stockData[s.ticker];
  if (!d) return;
  const qty = parseInt(document.getElementById('orderQuantity').value) || 0;
  const required = (d.price * qty) / gameState.leverage;
  DOM.osTotal.textContent = `Â¥${Math.round(required).toLocaleString()}`;
}

// ==================== ãƒã‚¸ã‚·ãƒ§ãƒ³è¡¨ç¤º ====================
function rebuildPositionsDOM() {
  const container = DOM.positions;
  container.innerHTML = '';
  if (gameState.positions.length === 0) {
    container.innerHTML = '<div class="no-positions">ãƒã‚¸ã‚·ãƒ§ãƒ³ãªã—</div>';
    return;
  }
  gameState.positions.forEach((pos, i) => {
    const item = document.createElement('div');
    item.className = 'position-item';
    item.innerHTML = `<div class="pos-header"><span class="pos-ticker"></span><div><span class="pos-pnl"></span><button class="btn-close-pos" data-idx="${i}">æ±ºæ¸ˆ</button></div></div><div class="pos-details"><span class="pos-info"></span><span class="pos-prices"></span></div>`;
    container.appendChild(item);
  });
  container.querySelectorAll('.btn-close-pos').forEach(btn => {
    btn.addEventListener('click', function() {
      closePosition(parseInt(this.getAttribute('data-idx')));
    });
  });
}

function updatePositionsDOM() {
  const container = DOM.positions;
  const posCount = gameState.positions.length;

  if (posCount === 0) {
    if (!container.querySelector('.no-positions')) {
      container.innerHTML = '<div class="no-positions">ãƒã‚¸ã‚·ãƒ§ãƒ³ãªã—</div>';
    }
    return;
  }

  const items = container.querySelectorAll('.position-item');
  if (items.length !== posCount) {
    rebuildPositionsDOM();
    return updatePositionsValues();
  }
  updatePositionsValues();
}

function updatePositionsValues() {
  const items = DOM.positions.querySelectorAll('.position-item');
  for (let i = 0; i < gameState.positions.length; i++) {
    const pos = gameState.positions[i];
    const d = stockData[pos.ticker];
    if (!d || !items[i]) continue;
    const pnl = pos.type === 'buy'
      ? (d.price - pos.entryPrice) * pos.quantity * pos.leverage
      : (pos.entryPrice - d.price) * pos.quantity * pos.leverage;
    const isUp = pnl >= 0;
    const item = items[i];

    const side = pos.type === 'buy' ? 'BUY' : 'SELL';
    const tradeColor = getTradeColor(side, gameState.marketColorMode);
    const tradeColorRGB = getTradeColorRGB(side, gameState.marketColorMode);

    // å·¦ãƒœãƒ¼ãƒ€ãƒ¼: å£²è²·æ–¹å‘ã®è‰²
    item.style.borderLeftColor = tradeColor;

    // ãƒ©ãƒ™ãƒ«: å£²è²·æ–¹å‘ã®è‰²
    const tickerEl = item.querySelector('.pos-ticker');
    tickerEl.innerHTML = `<span style="color:${tradeColor}">${pos.type === 'buy' ? 'è²·' : 'å£²'}</span> ${pos.ticker}`;

    // æç›Š: åˆ©ç›Š=ä¸Šæ˜‡è‰²ã€æå¤±=ä¸‹è½è‰²
    const pnlEl = item.querySelector('.pos-pnl');
    pnlEl.textContent = `${isUp ? '+' : ''}Â¥${Math.round(pnl).toLocaleString()}`;
    pnlEl.className = 'pos-pnl';
    pnlEl.style.color = isUp ? getUpColor() : getDownColor();

    // æ±ºæ¸ˆãƒœã‚¿ãƒ³: å£²è²·æ–¹å‘ã®è‰²
    const closeBtn = item.querySelector('.btn-close-pos');
    closeBtn.style.borderColor = `rgba(${tradeColorRGB},0.3)`;
    closeBtn.style.color = tradeColor;
    closeBtn.style.background = `rgba(${tradeColorRGB},0.08)`;

    item.querySelector('.pos-info').textContent = `${pos.quantity}æ ª Ã— ${pos.leverage}x`;
    item.querySelector('.pos-prices').textContent = `å–å¾—: Â¥${pos.entryPrice.toFixed(0)} â†’ ç¾åœ¨: Â¥${d.price.toFixed(0)}`;
  }
}

// ==================== è³‡ç”£è¡¨ç¤º ====================
function updateAssetDisplay() {
  let unrealized = 0;
  for (let i = 0; i < gameState.positions.length; i++) {
    const pos = gameState.positions[i];
    const d = stockData[pos.ticker];
    if (!d) continue;
    unrealized += pos.type === 'buy'
      ? (d.price - pos.entryPrice) * pos.quantity * pos.leverage
      : (pos.entryPrice - d.price) * pos.quantity * pos.leverage;
  }

  const totalAsset = gameState.cash + unrealized;
  DOM.totalAsset.textContent = `Â¥${Math.round(totalAsset).toLocaleString()}`;
  DOM.cash.textContent = `Â¥${Math.round(gameState.cash).toLocaleString()}`;

  const rp = gameState.realizedPnl;
  const isUp = rp >= 0;
  DOM.pnl.textContent = `${isUp ? '+' : ''}Â¥${Math.round(rp).toLocaleString()}`;
  DOM.pnl.className = `value ${isUp ? 'positive' : 'negative'}`;

  if (rp > gameState.maxProfit) gameState.maxProfit = rp;
}

function updateTimer() {
  const min = Math.floor(gameState.timeLeft / 60);
  const sec = gameState.timeLeft % 60;
  DOM.timer.textContent = `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
}

// ==================== æ“ä½œ ====================
function selectStock(index) {
  gameState.selectedStock = index;
  needsRender = true;
}

function setQuantity(qty) {
  document.getElementById('orderQuantity').value = qty;
  needsRender = true;
}

function setLeverage(lev) {
  gameState.leverage = lev;
  document.querySelectorAll('#leverageBtns button').forEach(btn => {
    btn.classList.toggle('selected', btn.textContent === `${lev}x`);
  });
  needsRender = true;
}

function executeOrder(type) {
  if (gameState.phase !== 'running') return;
  const s = STOCKS[gameState.selectedStock];
  const d = stockData[s.ticker];
  if (!d) return;
  const qty = parseInt(document.getElementById('orderQuantity').value) || 0;
  if (qty <= 0) { showToast('æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }

  const requiredCash = (d.price * qty) / gameState.leverage;
  if (requiredCash > gameState.cash) { showToast('è³‡é‡‘ãŒä¸è¶³ã—ã¦ã„ã¾ã™', 'error'); return; }

  gameState.cash -= requiredCash;
  const posId = generateId();
  gameState.positions.push({
    id: posId,
    ticker: s.ticker, name: s.name, type: type,
    entryPrice: d.price, quantity: qty,
    leverage: gameState.leverage, margin: requiredCash,
  });

  // å–å¼•ãƒ­ã‚°ä¿å­˜
  saveTrade({
    id: generateId(), userId: getLocalUserId(), symbol: s.ticker,
    side: type === 'buy' ? 'BUY' : 'SELL', qty: qty, price: d.price,
    leverage: gameState.leverage, executedAt: new Date().toISOString(),
    positionId: posId, action: 'OPEN', pnlDelta: 0,
  });

  addHistory({ action: type, ticker: s.ticker, price: d.price, quantity: qty, leverage: gameState.leverage });
  showToast(`${s.name} ${qty}æ ª ${type === 'buy' ? 'è²·ã„' : 'ç©ºå£²ã‚Š'} ç´„å®š`, 'success');

  rebuildPositionsDOM();
  needsRender = true;
}

function closePosition(index) {
  if (gameState.phase !== 'running') return;
  if (index < 0 || index >= gameState.positions.length) return;
  const pos = gameState.positions[index];
  const d = stockData[pos.ticker];
  if (!d) return;
  const pnl = pos.type === 'buy'
    ? (d.price - pos.entryPrice) * pos.quantity * pos.leverage
    : (pos.entryPrice - d.price) * pos.quantity * pos.leverage;

  gameState.cash += pos.margin + pnl;
  gameState.realizedPnl += pnl;
  gameState.settlementCount++;
  if (pnl > 0) gameState.winCount++;

  // æ±ºæ¸ˆã®å–å¼•ãƒ­ã‚°ä¿å­˜
  saveTrade({
    id: generateId(), userId: getLocalUserId(), symbol: pos.ticker,
    side: pos.type === 'buy' ? 'BUY' : 'SELL', qty: pos.quantity, price: d.price,
    leverage: pos.leverage, executedAt: new Date().toISOString(),
    positionId: pos.id || '', action: 'CLOSE', pnlDelta: pnl,
  });

  addHistory({ action: 'close', ticker: pos.ticker, price: d.price, quantity: pos.quantity, pnl: pnl, originalSide: pos.type });
  gameState.positions.splice(index, 1);

  rebuildPositionsDOM();
  showToast(`${pos.ticker} æ±ºæ¸ˆ ${pnl >= 0 ? '+' : ''}Â¥${Math.round(pnl).toLocaleString()}`, pnl >= 0 ? 'success' : 'error');
  needsRender = true;
}

function addHistory(h) {
  gameState.history.unshift(h);
  const container = DOM.history;
  if (gameState.history.length === 1) container.innerHTML = '';

  const item = document.createElement('div');
  item.className = 'history-item';
  const label = h.action === 'buy' ? 'è²·ã„' : h.action === 'sell' ? 'ç©ºå£²ã‚Š' : 'æ±ºæ¸ˆ';

  // å£²è²·æ–¹å‘ã«åŸºã¥ãè‰²ã‚’é©ç”¨ï¼ˆæ±ºæ¸ˆã®å ´åˆã¯å…ƒãƒã‚¸ã‚·ãƒ§ãƒ³ã®æ–¹å‘ã‚’ä½¿ç”¨ï¼‰
  const side = h.action === 'close'
    ? (h.originalSide === 'sell' ? 'SELL' : 'BUY')
    : (h.action === 'buy' ? 'BUY' : 'SELL');
  const tradeColor = getTradeColor(side, gameState.marketColorMode);

  let detail = `${h.ticker} ${h.quantity}æ ª @Â¥${h.price.toFixed(0)}`;
  if (h.action === 'close') detail += ` (${h.pnl >= 0 ? '+' : ''}Â¥${Math.round(h.pnl).toLocaleString()})`;
  item.innerHTML = `<span class="h-action" style="color:${tradeColor}">${label}</span><span>${detail}</span>`;
  container.prepend(item);
}

// ==================== ãƒˆãƒ¼ã‚¹ãƒˆ ====================
function showToast(msg, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = msg;
  DOM.toasts.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// ==================== ã‚²ãƒ¼ãƒ åˆ¶å¾¡ (state machine) ====================
function cleanupIntervals() {
  clearInterval(tickInterval);
  clearInterval(timerInterval);
  clearTimeout(startDelayTimer);
  if (rafId) cancelAnimationFrame(rafId);
  tickInterval = null;
  timerInterval = null;
  startDelayTimer = null;
  rafId = null;
}

function startGame() {
  // â”€â”€ phase â†’ starting â”€â”€
  cleanupIntervals();
  gameState.phase = 'starting';
  gameState.running = false;

  // ãƒªã‚»ãƒƒãƒˆ
  initStocks();
  gameState.cash = 1000000;
  gameState.initialCash = 1000000;
  gameState.realizedPnl = 0;
  gameState.positions = [];
  gameState.history = [];
  gameState.settlementCount = 0;
  gameState.winCount = 0;
  gameState.maxProfit = 0;
  gameState.selectedStock = 0;

  document.getElementById('startScreen').classList.add('hidden');
  document.getElementById('resultScreen').classList.remove('show');
  document.getElementById('btnStart').disabled = true;
  DOM.history.innerHTML = '<div class="no-positions">ã¾ã å–å¼•ãŒã‚ã‚Šã¾ã›ã‚“</div>';

  buildStockList();
  updateTimer();

  // åˆæœŸã®ãƒãƒ£ãƒ¼ãƒˆã‚’æç”»ï¼ˆé™æ­¢çŠ¶æ…‹ï¼‰
  updateStockListDOM();
  updateChartHeader();
  updateOrderInfo();
  drawCandlestickChart();

  // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³æ¼”å‡º
  DOM.countdown.classList.add('show');
  DOM.countdownText.textContent = 'Ready...';
  DOM.countdownText.style.animation = 'none';
  void DOM.countdownText.offsetWidth;
  DOM.countdownText.style.animation = '';

  startDelayTimer = setTimeout(() => {
    // â”€â”€ phase â†’ running â”€â”€
    DOM.countdownText.textContent = 'GO!';
    DOM.countdownText.style.animation = 'none';
    void DOM.countdownText.offsetWidth;
    DOM.countdownText.style.animation = '';

    setTimeout(() => {
      DOM.countdown.classList.remove('show');
    }, 400);

    gameState.phase = 'running';
    gameState.running = true;
    document.getElementById('btnStart').disabled = false;
    needsRender = true;

    const config = TIME_CONFIGS[gameState.totalTime] || TIME_CONFIGS[180];
    tickInterval = setInterval(updatePrices, config.tickMs);
    timerInterval = setInterval(() => {
      if (gameState.phase !== 'running') return;
      gameState.timeLeft--;
      updateTimer();
      if (gameState.timeLeft <= 0) endGame();
    }, 1000);

    candleStartTime = Date.now();
    renderLoop();
  }, 1000);
}

function endGame() {
  // â”€â”€ phase â†’ ended â”€â”€
  gameState.phase = 'ended';
  gameState.running = false;
  cleanupIntervals();

  // å…¨ãƒã‚¸ã‚·ãƒ§ãƒ³å¼·åˆ¶æ±ºæ¸ˆ
  while (gameState.positions.length > 0) {
    const pos = gameState.positions[0];
    const d = stockData[pos.ticker];
    if (d) {
      const pnl = pos.type === 'buy'
        ? (d.price - pos.entryPrice) * pos.quantity * pos.leverage
        : (pos.entryPrice - d.price) * pos.quantity * pos.leverage;
      gameState.cash += pos.margin + pnl;
      gameState.realizedPnl += pnl;
      gameState.settlementCount++;
      if (pnl > 0) gameState.winCount++;
      // å¼·åˆ¶æ±ºæ¸ˆã®å–å¼•ãƒ­ã‚°ä¿å­˜
      saveTrade({
        id: generateId(), userId: getLocalUserId(), symbol: pos.ticker,
        side: pos.type === 'buy' ? 'BUY' : 'SELL', qty: pos.quantity, price: d.price,
        leverage: pos.leverage, executedAt: new Date().toISOString(),
        positionId: pos.id || '', action: 'CLOSE', pnlDelta: pnl,
      });
    }
    gameState.positions.shift();
  }

  // ã‚²ãƒ¼ãƒ çµæœã‚’ä¿å­˜
  const gameResult = {
    id: generateId(), userId: getLocalUserId(), userName: getLocalUserName(),
    realizedPnl: gameState.realizedPnl, tradeCount: gameState.settlementCount,
    winCount: gameState.winCount, loseCount: gameState.settlementCount - gameState.winCount,
    duration: gameState.totalTime, completedAt: new Date().toISOString(),
  };
  const resultSaved = saveGameResult(gameResult);

  const totalPnl = gameState.realizedPnl;
  const isUp = totalPnl >= 0;
  const winRate = gameState.settlementCount > 0
    ? Math.round((gameState.winCount / gameState.settlementCount) * 100) : 0;

  document.getElementById('resultIcon').textContent = isUp ? 'ğŸ†' : 'ğŸ“‰';
  document.getElementById('resultTitle').textContent = isUp ? 'åˆ©ç›Šé”æˆï¼' : 'ã‚²ãƒ¼ãƒ çµ‚äº†';

  const amountEl = document.getElementById('resultAmount');
  amountEl.textContent = `${isUp ? '+' : ''}Â¥${Math.round(totalPnl).toLocaleString()}`;
  amountEl.className = `result-amount ${isUp ? 'positive' : 'negative'}`;

  document.getElementById('rsFinalAsset').textContent = `Â¥${Math.round(gameState.cash).toLocaleString()}`;
  document.getElementById('rsTradeCount').textContent = `${gameState.settlementCount}å›`;
  document.getElementById('rsWinRate').textContent = `${winRate}%`;
  document.getElementById('rsMaxProfit').textContent = `+Â¥${Math.round(Math.max(0, gameState.maxProfit)).toLocaleString()}`;

  document.getElementById('resultScreen').classList.add('show');

  // ä¿å­˜ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
  const saveEl = document.getElementById('saveStatus');
  if (!storageAvailable) {
    saveEl.textContent = 'ä¿å­˜ä¸å¯: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“';
    saveEl.className = 'save-status fail';
  } else if (resultSaved) {
    saveEl.textContent = 'æˆç¸¾ã‚’ä¿å­˜ã—ã¾ã—ãŸ';
    saveEl.className = 'save-status ok';
  } else {
    saveEl.textContent = 'ä¿å­˜ä¸å¯: ãƒ‡ãƒ¼ã‚¿ã®æ›¸ãè¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
    saveEl.className = 'save-status fail';
  }
}

// ==================== æˆç¸¾ç”»é¢æç”» ====================
function renderStatsScreen() {
  const statusEl = document.getElementById('statsStorageStatus');
  const contentEl = document.getElementById('statsContent');

  if (!storageAvailable) {
    statusEl.innerHTML = '<div class="status-msg error">å–å¾—ä¸å¯: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“</div>';
    contentEl.innerHTML = '';
    return;
  }

  statusEl.innerHTML = '';
  const { error, summaries, totalGames } = getStatsSummary();
  if (error) {
    statusEl.innerHTML = `<div class="status-msg error">${error}</div>`;
    contentEl.innerHTML = '';
    return;
  }

  const periodLabels = { DAILY: 'ä»Šæ—¥', WEEKLY: 'ä»Šé€±', MONTHLY: 'ä»Šæœˆ', ALL: 'å…¨æœŸé–“' };
  let html = '<div class="pnl-cards">';
  for (const p of ['DAILY', 'WEEKLY', 'MONTHLY', 'ALL']) {
    const s = summaries[p];
    const isUp = s.realizedPnl >= 0;
    const cls = s.realizedPnl > 0 ? 'up' : s.realizedPnl < 0 ? 'down' : '';
    html += `<div class="pnl-card">
      <div class="pc-label">${periodLabels[p]}</div>
      <div class="pc-value ${cls}">${isUp ? '+' : ''}Â¥${Math.round(s.realizedPnl).toLocaleString()}</div>
      <div class="pc-sub">${s.tradeCount}å›æ±ºæ¸ˆ</div>
    </div>`;
  }
  html += '</div>';

  // è©³ç´°çµ±è¨ˆ
  const all = summaries.ALL;
  const winRate = all.tradeCount > 0 ? Math.round((all.winCount / all.tradeCount) * 100) : 0;
  const avgPnl = all.tradeCount > 0 ? Math.round(all.realizedPnl / all.tradeCount) : 0;

  html += '<div class="stats-detail-section"><h3>å…¨æœŸé–“ã‚µãƒãƒªãƒ¼</h3>';
  html += `<div class="stats-detail-row"><span class="sd-label">ãƒ—ãƒ¬ã‚¤å›æ•°</span><span class="sd-value">${totalGames}å›</span></div>`;
  html += `<div class="stats-detail-row"><span class="sd-label">ç·æ±ºæ¸ˆå›æ•°</span><span class="sd-value">${all.tradeCount}å›</span></div>`;
  html += `<div class="stats-detail-row"><span class="sd-label">å‹ã¡ / è² ã‘</span><span class="sd-value">${all.winCount}å‹ ${all.loseCount}æ•—</span></div>`;
  html += `<div class="stats-detail-row"><span class="sd-label">å‹ç‡</span><span class="sd-value">${winRate}%</span></div>`;
  html += `<div class="stats-detail-row"><span class="sd-label">å¹³å‡æç›Šï¼ˆ1æ±ºæ¸ˆï¼‰</span><span class="sd-value">${avgPnl >= 0 ? '+' : ''}Â¥${avgPnl.toLocaleString()}</span></div>`;
  html += `<div class="stats-detail-row"><span class="sd-label">ç´¯è¨ˆå®Ÿç¾æç›Š</span><span class="sd-value">${all.realizedPnl >= 0 ? '+' : ''}Â¥${Math.round(all.realizedPnl).toLocaleString()}</span></div>`;
  html += '</div>';

  contentEl.innerHTML = html;
}

// ==================== ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢æç”» ====================
let currentRankingPeriod = 'ALL';

function renderRankingScreen(periodType) {
  currentRankingPeriod = periodType || currentRankingPeriod;
  const statusEl = document.getElementById('rankingStorageStatus');
  const contentEl = document.getElementById('rankingContent');

  // ã‚¿ãƒ–çŠ¶æ…‹æ›´æ–°
  document.querySelectorAll('#rankingPeriodTabs .period-tab').forEach(tab => {
    tab.classList.toggle('active', tab.dataset.period === currentRankingPeriod);
  });

  if (!storageAvailable) {
    statusEl.innerHTML = '<div class="status-msg error">å–å¾—ä¸å¯: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“</div>';
    contentEl.innerHTML = '';
    return;
  }

  statusEl.innerHTML = '';
  const { error, data } = getRanking(currentRankingPeriod);
  if (error) {
    statusEl.innerHTML = `<div class="status-msg error">${error}</div>`;
    contentEl.innerHTML = '';
    return;
  }

  if (data.length === 0) {
    contentEl.innerHTML = '<div class="ranking-empty">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }

  const myId = getLocalUserId();
  let html = '<div class="ranking-table">';
  html += '<div class="ranking-header"><span>#</span><span>ãƒ¦ãƒ¼ã‚¶ãƒ¼</span><span style="text-align:right">åˆ©ç›Šé¡</span><span style="text-align:right">æ±ºæ¸ˆæ•°</span></div>';

  for (let i = 0; i < data.length; i++) {
    const r = data[i];
    const rank = i + 1;
    const isSelf = r.userId === myId;
    const isUp = r.realizedPnl >= 0;
    const rankCls = rank <= 3 ? ` top-${rank}` : '';
    html += `<div class="ranking-row${isSelf ? ' self' : ''}">
      <span class="rank${rankCls}">${rank}</span>
      <span class="r-name">${escapeHtml(r.userName || 'User#???')}</span>
      <span class="r-pnl ${isUp ? 'up' : 'down'}">${isUp ? '+' : ''}Â¥${Math.round(r.realizedPnl).toLocaleString()}</span>
      <span class="r-trades">${r.tradeCount}å›</span>
    </div>`;
  }
  html += '</div>';
  contentEl.innerHTML = html;
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// ==================== ã‚¤ãƒ™ãƒ³ãƒˆ ====================
document.addEventListener('DOMContentLoaded', () => {
  cacheDom();
  checkStorageAvailability();

  document.getElementById('btnStart').addEventListener('click', () => {
    if (gameState.phase === 'starting') return; // äºŒé‡èµ·å‹•é˜²æ­¢
    startGame();
  });
  document.getElementById('btnRestart').addEventListener('click', () => {
    if (gameState.phase === 'starting') return;
    gameState.timeLeft = gameState.totalTime;
    startGame();
  });

  document.querySelectorAll('#timeSelect button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#timeSelect button').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      gameState.timeLeft = parseInt(btn.dataset.time);
      gameState.totalTime = parseInt(btn.dataset.time);
    });
  });

  // è‰²ãƒ¢ãƒ¼ãƒ‰é¸æŠ
  document.querySelectorAll('#colorSelect button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#colorSelect button').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      if (btn.dataset.mode === 'reverse') {
        document.documentElement.classList.add('color-reverse');
        gameState.marketColorMode = 'RISE_RED';
      } else {
        document.documentElement.classList.remove('color-reverse');
        gameState.marketColorMode = 'RISE_GREEN';
      }
    });
  });

  // æˆç¸¾ç”»é¢
  document.getElementById('btnOpenStats').addEventListener('click', () => {
    renderStatsScreen();
    document.getElementById('statsScreen').classList.add('show');
  });
  document.getElementById('btnResultStats').addEventListener('click', () => {
    renderStatsScreen();
    document.getElementById('statsScreen').classList.add('show');
  });
  document.getElementById('btnCloseStats').addEventListener('click', () => {
    document.getElementById('statsScreen').classList.remove('show');
  });

  // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢
  document.getElementById('btnOpenRanking').addEventListener('click', () => {
    renderRankingScreen('ALL');
    document.getElementById('rankingScreen').classList.add('show');
  });
  document.getElementById('btnResultRanking').addEventListener('click', () => {
    renderRankingScreen('ALL');
    document.getElementById('rankingScreen').classList.add('show');
  });
  document.getElementById('btnCloseRanking').addEventListener('click', () => {
    document.getElementById('rankingScreen').classList.remove('show');
  });

  // ãƒ©ãƒ³ã‚­ãƒ³ã‚°æœŸé–“ã‚¿ãƒ–
  document.querySelectorAll('#rankingPeriodTabs .period-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      renderRankingScreen(tab.dataset.period);
    });
  });

  // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  document.getElementById('statsScreen').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) e.currentTarget.classList.remove('show');
  });
  document.getElementById('rankingScreen').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) e.currentTarget.classList.remove('show');
  });

  window.addEventListener('resize', () => { lastCanvasW = 0; needsRender = true; });

  initStocks();
  buildStockList();
  updateStockListDOM();
  updateChartHeader();
  updateOrderInfo();
  drawCandlestickChart();
});
</script>
</body>
</html>
